#import "./template/template.typ": *

#show: project.with(
  title: "Отчёт по практической работе №6",
  theme: "",
  department: "Математического обеспечения и стандартизации информационных технологий",
  course: "Разработка кроссплатформенных мобильных приложений",
  authors: (
    "Буренин А.А.",
  ),
  lecturer: "Шешуков Л.С.",
  lecturer_grade: "Старший преподаватель кафедры МОСИТ",
  group: "ИКБО-07-22",
  date: datetime.today(),
  add_toc: false,
)

#let img(path) = "./imgs/" + path + ".png"
#let r(inner, supplement: "рисунке") = ref(inner, supplement: supplement)

= Подключение внешних зависимостей во Flutter

В разработке приложений на Flutter часто возникает необходимость в использовании внешних библиотек (пакетов), которые расширяют функциональность базового фреймворка. Для управления этими зависимостями используется файл pubspec.yaml, который является конфигурационным файлом проекта. В нём определяются два ключевых раздела для зависимостей:

- *dependencies*: Основные зависимости, необходимые для работы приложения в продакшене (например, библиотеки для сетевых запросов, UI-компонентов или интеграции с сервисами).

- *dev_dependencies*: Зависимости для разработки и тестирования (например, инструменты для unit-тестов или линтинга кода), которые не включаются в финальную сборку приложения.

Процесс добавления зависимости включает указание её имени, источника и, при необходимости, версии. После редактирования pubspec.yaml выполняется команда flutter pub get (или автоматически в IDE), чтобы скачать и установить пакеты. Зависимости классифицируются по источникам на три основных типа.

== Зависимости из облаков

Pub.dev (https://pub.dev) — это официальный публичный репозиторий пакетов для языков Dart и фреймворка Flutter, поддерживаемый Google и сообществом. Он содержит тысячи пакетов, включая как открытые от разработчиков, так и официальные от команды Flutter.

Страница каждого пакета содержит его название, актуальную версию, дату публикации, автора и другую информацию, которая может быть полезна при использовании пакета.

Для подключения зависимости в разделе dependencies pubspec.yaml требуется указать имя пакета и версию (если требуется). Например, для подключения пакета cached_network_image версии 3.4.1:

#listing(
  body: raw("
  dependencies:
    cached_network_image: ^3.4.1
  "),
  caption: "Добавление библиотеки в pubspec.yaml",
)

== Зависимости из Git

Не все пакеты публикуются на pub.dev — иногда они находятся в приватных или открытых репозиториях на платформах вроде GitHub, GitLab или Bitbucket. Это полезно для форков, экспериментальных версий или внутренних библиотек компании.

При подключении зависимости из Git требуется указать в обязательном порядке маршрут до пакета, а также ветку или коммит, который требуется подключить. Полный синтаксис подключения пакета из Git:

#listing(
  body: raw(
    "
dependencies:
  <dependency_name>:
    git:
      url: https://github.com/<repo_url>
      ref: some-branch
      path: some-path
  ",
  ),
  caption: "Добавление библиотеки в pubspec.yaml",
)


== Локальные зависимости

Для небольших, внутренних пакетов, которые не стоит выносить в отдельный репозиторий, используется локальное размещение. Такие пакеты всё равно являются полноценными Dart-пакетами, но хранятся в поддиректории проекта.

Для подключения нужно прописать полный или относительный путь до этой зависимости:

#listing(
  body: raw(
    "
dependencies:
  <dependency_name>:
    path: <local_path>
  ",
  ),
  caption: "Добавление библиотеки в pubspec.yaml",
)

= Версионирование зависимостей

Версионирование — ключевой аспект управления зависимостями, чтобы обеспечить совместимость и стабильность. В Dart/Flutter используется семантическое версионирование (SemVer), где версия представлена в формате major.minor.patch (например, 1.2.3):

- *Major (мажор)*: увеличивается при breaking changes — изменениях API, которые ломают обратную совместимость. Это может потребовать переписывания кода в вашем приложении.

- *Minor (минор)*: увеличивается при добавлении новой функциональности без нарушения совместимости. Код, работавший с предыдущей версией, продолжит работать.

- *Patch (патч)*: увеличивается при исправлении багов, не затрагивающих API. Это чистые фиксы для стабильности.

В pubspec.yaml версии указываются с использованием constraints (ограничений) — операторов, которые определяют диапазон допустимых версий. Pub (менеджер пакетов Dart) автоматически выберет наилучшую версию в пределах ограничений, учитывая зависимости других пакетов.

Основные операторы:

- *any*: любая версия (эквивалентно отсутствию указания версии). Полезно для быстрого прототипирования, но рискованно для продакшена из-за возможных breaking changes.

- *x.y.z*: точная версия (например, 1.2.3). Фиксирует на конкретной, избегая обновлений.

- *>x.y.z*: строго выше указанной (например, >1.2.3 — версии от 1.2.4 и выше).

- *>=x.y.z*: выше или равна (например, >=1.2.3 — от 1.2.3 и выше).

- *\<x.y.z*: строго ниже (например, \<2.0.0 — версии до 1.99.99).

- *<=x.y.z*: ниже или равна (например, <=1.2.3 — до 1.2.3 включительно).

- *^x.y.z (caret)*: Диапазон для совместимых обновлений. Для major > 0: >=x.y.z < (x+1).0.0 (например, ^1.2.3 — от 1.2.3 до 1.99.99, но не 2.0.0). Для major = 0 (бета-версии): >=0.y.z < 0.(y+1).0 (например, ^0.1.2 — от 0.1.2 до 0.1.99, но не 0.2.0), так как минорные изменения могут быть breaking.

= Кеширование изображений из сети

В приложениях, работающих с сетевыми изображениями (например, соцсети, галереи), повторная загрузка одного и того же изображения приводит к неэффективному использованию трафика, нагрузке на сервер и задержкам для пользователя. Пример: в ленте новостей пользователь видит миниатюру поста, затем открывает детали и добавляет в избранное — без кеша изображение загружается заново каждый раз, что ухудшает UX.

Flutter имеет встроенный механизм, позволяющий управлять файлами в определенном каталоге, предназначенном для временных файлов. Основная цель этого каталога — хранить временные данные, которые могут быть восстановлены приложением в случае их удаления. Цель этого каталога — улучшить общую производительность или каким-либо образом улучшить взаимодействие с пользователем. Тем не менее, управление этими файлами может быть скучным и утомительным. Чтобы упростить этот процесс, существует пакет cached_network_image, который абстрагирует от управления кеш-памятью. Этот пакет позаботится о загрузке изображения в первый раз, сохранит его в кеше и извлечёт его оттуда, если то же изображение будет запрошено снова.

== Подключение в проект

Для подключения пакета cached_network_image версии 3.4.1 в проект требуется в файл pubspec.yaml добавить пакет в dependencies. Данная версия выбрана так как является самой последней и актуальной на момент выполнения работы.

Альтернативным вариантом является введение команды "flutter pub add cached_network_image" в терминале, смотрящим в директорию проекта.

== Отображение картинки

Пакет cached_network_image предоставляет доступ к виджету CachedNetworkImage. Данный виджет создан для отображения изображения из сети интернет с последующим его кешированием. Для установки искомого изображения необходимо передать сетевой маршрут до него в аргумент виджета imageUrl. При первом запросе на рендеринг этого изображения CachedNetworkImage загрузит его из Интернета и сохранит, а затем будет извлекать его из кеша.

Виджет также поддерживает дополнительные параметры:
- *placeholder*: виджет, отображаемый во время загрузки изображения
- *errorWidget*: виджет, отображаемый при ошибке загрузки
- *fit*: определяет, как изображение должно вписываться в доступное пространство

= Выполнение практической работы №6

В рамках модернизации приложения для трекинга привычек, разработанного в предыдущих практических работах, была добавлена поддержка загрузки иконок привычек из сети интернет вместо использования предустановленных иконок.

Для обеспечения корректной работы приложения был добавлен пакет cached_network_image. Данный пакет позволяет загружать изображения из сети с автоматическим кешированием, что обеспечивает их доступность даже при отсутствии интернет-соединения после первой загрузки.

Добавление зависимости в файл pubspec.yaml проиллюстрировано в #r(<lst-pubspec>).

#listing(
  file: "../pubspec.yaml",
  caption: [Добавление зависимости cached_network_image],
  from: 30,
  to: 37,
) <lst-pubspec>

Для реализации новой функциональности были внесены изменения в несколько ключевых файлов проекта.

== Изменения в модели данных

В первую очередь была изменена структура сущности Habbit. Ранее для хранения иконки использовался enum HabbitIcon с фиксированным набором значений. Этот подход был заменён на использование строкового поля iconUrl, которое хранит URL изображения иконки.

Изменения в файле habbit.dart показаны в #r(<lst-habbit>). Удалён enum HabbitIcon, а поле icon типа HabbitIcon заменено на поле iconUrl типа String. Соответственно были обновлены конструкторы и методы копирования объекта.

#listing(
  file: "../lib/features/entities/habbit.dart",
  caption: [Изменённая структура сущности Habbit],
  from: 1,
  to: 28,
) <lst-habbit>

Также был изменён метод копирования с модификацией иконки в #r(<lst-habbit-copy>).

#listing(
  file: "../lib/features/entities/habbit.dart",
  caption: [Метод изменения URL иконки],
  from: 56,
  to: 74,
) <lst-habbit-copy>

== Изменения в форме создания привычки

В форме создания/редактирования привычки был полностью переработан UI выбора иконки. Вместо визуального выбора из предустановленного набора иконок теперь используется текстовое поле для ввода URL изображения.

В #r(<lst-form-controller>) показано изменение контроллеров формы — вместо переменной _selectedIcon добавлен _iconUrlController для работы с текстовым полем.

#listing(
  file: "../lib/features/screens/habbit_form_screen.dart",
  caption: [Контроллеры формы с полем URL иконки],
  from: 19,
  to: 30,
) <lst-form-controller>

Изменение валидации формы представлено в #r(<lst-form-validation>). Теперь форма считается валидной, если URL иконки не пустой.

#listing(
  file: "../lib/features/screens/habbit_form_screen.dart",
  caption: [Валидация формы],
  from: 32,
  to: 37,
) <lst-form-validation>

UI формы теперь содержит простое текстовое поле для ввода URL вместо набора иконок, как показано в #r(<lst-form-ui>).

#listing(
  file: "../lib/features/screens/habbit_form_screen.dart",
  caption: [UI текстового поля для URL иконки],
  from: 110,
  to: 119,
) <lst-form-ui>

== Изменения в отображении привычки

Самые существенные изменения были внесены в виджет HabbitItem, отвечающий за отображение отдельной привычки в списке. Вместо использования стандартного виджета Icon теперь применяется CachedNetworkImage для загрузки и кеширования изображений.

В #r(<lst-item-import>) показан импорт пакета cached_network_image.

#listing(
  file: "../lib/features/widgets/habbit_item.dart",
  caption: [Импорт пакета cached_network_image],
  from: 1,
  to: 3,
) <lst-item-import>

Удалён метод \_getIconData, который ранее преобразовывал enum в IconData. Вместо него теперь используется прямое обращение к полю habbit.iconUrl.

Ключевое изменение — использование виджета CachedNetworkImage, как показано в #r(<lst-item-image>). Виджет настроен с параметрами:
- *imageUrl*: URL изображения из модели привычки
- *fit*: BoxFit.cover для правильного масштабирования
- *placeholder*: индикатор загрузки, отображаемый во время скачивания
- *errorWidget*: иконка ошибки, показываемая при неудачной загрузке

#listing(
  file: "../lib/features/widgets/habbit_item.dart",
  caption: [Использование CachedNetworkImage для отображения иконки],
  from: 23,
  to: 46,
) <lst-item-image>

== Изменения в интерфейсе контроллера

Интерфейс HabbitsController был обновлён для работы с новой структурой данных. Везде, где ранее использовался тип HabbitIcon, теперь используется String iconUrl.

Изменения в методах addHabbit и editHabbit показаны в #r(<lst-controller>).

#listing(
  file: "../lib/features/widgets/habbits_controller.dart",
  caption: [Обновлённый интерфейс HabbitsController],
  from: 5,
  to: 21,
) <lst-controller>

Аналогичные изменения были внесены в реализацию контроллера в классе HabbitsContainer, как показано в #r(<lst-container-add>) и #r(<lst-container-edit>).

#listing(
  file: "../lib/features/state/habbits_container.dart",
  caption: [Реализация addHabbit в HabbitsContainer],
  from: 31,
  to: 47,
) <lst-container-add>

#listing(
  file: "../lib/features/state/habbits_container.dart",
  caption: [Реализация editHabbit в HabbitsContainer],
  from: 126,
  to: 136,
) <lst-container-edit>

== Демонстрация работы приложения

После внесения всех изменений приложение было протестировано в двух режимах: с подключением к интернету и без него.

На #r(<img-add>) показан экран добавления новой привычки с полем для ввода URL иконки.

#picture(
  path: img("add_habbit"),
  caption: [Экран добавления привычки с URL иконки],
  width: 30%,
) <img-add>

#r(<img-first>, supplement: "Рисунок") демонстрирует список привычек после добавления нескольких записей. Все иконки успешно загружены из интернета.

#picture(
  path: img("first_added"),
  caption: [Список привычек с загруженными иконками],
  width: 30%,
) <img-first>

Для проверки функциональности кеширования было проведено тестирование с активным подключением к интернету (#r(<img-internet>)) и без него (#r(<img-no-internet>)).

#picture(
  path: img("result_internet"),
  caption: [Отображение привычек при наличии интернета],
  width: 29%,
) <img-internet>

#picture(
  path: img("result_no_internet"),
  caption: [Отображение привычек без подключения к интернету],
  width: 29%,
) <img-no-internet>

Как видно из #r(<img-no-internet>), после первоначальной загрузки изображения остаются доступными даже при отсутствии интернет-соединения. Это подтверждает корректную работу механизма кеширования, реализованного пакетом cached_network_image.

Таким образом, приложение стало более гибким — пользователи могут использовать любые изображения для визуализации своих привычек, а не ограничиваться предустановленным набором иконок. При этом сохранена возможность работы в офлайн-режиме благодаря кешированию загруженных изображений.

= Вывод

В ходе выполнения практической работы было модернизировано приложение для трекинга привычек путём добавления поддержки загрузки пользовательских иконок из сети интернет. Реализация была выполнена с использованием пакета cached_network_image версии 3.4.1, который обеспечивает автоматическое кеширование загруженных изображений.

Были внесены изменения в структуру данных (замена enum HabbitIcon на String iconUrl), интерфейс пользователя (замена визуального выбора иконок на текстовое поле для ввода URL) и компоненты отображения (использование виджета CachedNetworkImage вместо Icon).

Тестирование подтвердило корректную работу приложения как при наличии интернет-соединения (загрузка и кеширование новых изображений), так и при его отсутствии (отображение ранее закешированных изображений). Это обеспечивает хороший пользовательский опыт и эффективное использование сетевых ресурсов.

Итоговый код приложения размещен по ссылке

https://github.com/burenotti/mirea-crossplatform-2/tree/burenin/practice-6
